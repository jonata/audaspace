[build-system]
requires = ["scikit-build-core>=0.10", "pybind11", "numpy"]
build-backend = "scikit_build_core.build"

[project]
name = "audaspace"
version = "1.8.0"
description = "Audaspace is a high level audio library."
readme = "README.md"
license = {text = "Apache License 2.0"}
authors = [
    {name = "Jörg Müller", email = "nexyon@gmail.com"}
]
requires-python = ">=3.8"
dependencies = ["numpy>=1.19.0"]
keywords = ["audio", "sound", "3d-audio", "spatial-audio"]
classifiers = [
    "Development Status :: 5 - Production/Stable",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: Apache Software License",
    "Operating System :: MacOS :: MacOS X",
    "Operating System :: Microsoft :: Windows",
    "Operating System :: POSIX :: Linux",
    "Programming Language :: C++",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Topic :: Multimedia :: Sound/Audio",
]

[project.urls]
Homepage = "https://github.com/audaspace/audaspace"
Documentation = "https://audaspace.github.io"
Repository = "https://github.com/audaspace/audaspace"
Issues = "https://github.com/audaspace/audaspace/issues"

[tool.scikit-build]
cmake.verbose = false
cmake.build-type = "Release"
minimum-version = "0.10"
build-dir = "build/{wheel_tag}"
wheel.packages = []
wheel.py-api = "cp38"

# Use custom install for the Python module
install.strip = false

[tool.scikit-build.cmake.define]
# Core build settings
BUILD_DEMOS = "OFF"
WITH_DOCS = "OFF"
WITH_BINDING_DOCS = "OFF"
WITH_C = "ON"
SEPARATE_C = "OFF"
SHARED_LIBRARY = "ON"
AUDASPACE_STANDALONE = "OFF"

# Python settings - use the traditional setup.py method for now but install to wheel
WITH_PYTHON = "ON"
WITH_PYTHON_MODULE = "ON"

# Enable all audio backends with static linking
WITH_FFMPEG = "ON"
WITH_LIBSNDFILE = "ON"
WITH_OPENAL = "ON"
WITH_SDL = "ON"
WITH_FFTW = "ON"
USE_SDL2 = "ON"

# Build plugins as static (embedded in the main library)
PLUGIN_FFMPEG = "OFF"
PLUGIN_LIBSNDFILE = "OFF"
PLUGIN_OPENAL = "OFF"
PLUGIN_SDL = "OFF"

# Platform-specific overrides
[[tool.scikit-build.overrides]]
if.platform-system = "linux"
cmake.define.WITH_JACK = "ON"
cmake.define.WITH_PULSEAUDIO = "ON"
cmake.define.WITH_PIPEWIRE = "ON"
cmake.define.PLUGIN_JACK = "OFF"
cmake.define.PLUGIN_PULSEAUDIO = "OFF"
cmake.define.PLUGIN_PIPEWIRE = "OFF"

[[tool.scikit-build.overrides]]
if.platform-system = "darwin"
cmake.define.WITH_COREAUDIO = "ON"
cmake.define.PLUGIN_COREAUDIO = "OFF"
cmake.define.CMAKE_OSX_DEPLOYMENT_TARGET = "11.0"

[[tool.scikit-build.overrides]]
if.platform-system = "win32"
cmake.define.WITH_WASAPI = "ON"
cmake.define.PLUGIN_WASAPI = "OFF"

[tool.cibuildwheel]
# Build for all platforms
build = "cp38-* cp39-* cp310-* cp311-* cp312-* cp313-*"
skip = "*-musllinux* pp*"

# Test command to ensure the wheel works
test-requires = ["numpy"]
test-command = [
    "python -c \"import aud; print('audaspace version:', aud.__version__ if hasattr(aud, '__version__') else '1.8.0'); d = aud.Device(); print('Device created successfully')\""
]

[tool.cibuildwheel.linux]
# Use manylinux2014 for better compatibility
manylinux-x86_64-image = "manylinux2014"
manylinux-aarch64-image = "manylinux2014"

# Install dependencies via yum in manylinux container
before-all = [
    "yum install -y epel-release",
    "yum install -y cmake3 wget tar",
    # Install vcpkg for dependency management
    "git clone https://github.com/Microsoft/vcpkg.git /opt/vcpkg || true",
    "cd /opt/vcpkg && ./bootstrap-vcpkg.sh || true",
    "export VCPKG_ROOT=/opt/vcpkg",
    "/opt/vcpkg/vcpkg install ffmpeg[core,avcodec,avformat,avutil,swresample]:x64-linux libsndfile:x64-linux openal-soft:x64-linux sdl2:x64-linux fftw3:x64-linux || echo 'vcpkg install may have partial success'",
]

environment = {CMAKE_PREFIX_PATH="/opt/vcpkg/installed/x64-linux", PKG_CONFIG_PATH="/opt/vcpkg/installed/x64-linux/lib/pkgconfig"}

# Use auditwheel to bundle shared libraries
repair-wheel-command = "auditwheel repair -w {dest_dir} {wheel}"

[tool.cibuildwheel.macos]
# macOS deployment target
environment = {MACOSX_DEPLOYMENT_TARGET="11.0"}

# Install dependencies via homebrew
before-all = [
    "brew install cmake ffmpeg libsndfile openal-soft sdl2 fftw pkg-config || true",
]

# Use delocate to bundle shared libraries
repair-wheel-command = "delocate-wheel --require-archs {delocate_archs} -w {dest_dir} -v {wheel}"

[tool.cibuildwheel.windows]
# Install dependencies via vcpkg
before-all = [
    "git clone https://github.com/Microsoft/vcpkg.git C:\\vcpkg-build || exit 0",
    "C:\\vcpkg-build\\bootstrap-vcpkg.bat || exit 0",
    "C:\\vcpkg-build\\vcpkg.exe install ffmpeg[core,avcodec,avformat,avutil,swresample]:x64-windows libsndfile:x64-windows openal-soft:x64-windows sdl2:x64-windows fftw3:x64-windows --clean-after-build || echo vcpkg install may have partial success",
]

environment = {CMAKE_PREFIX_PATH="C:\\vcpkg-build\\installed\\x64-windows", CMAKE_TOOLCHAIN_FILE="C:\\vcpkg-build\\scripts\\buildsystems\\vcpkg.cmake"}

# Use delvewheel to bundle DLLs
repair-wheel-command = "delvewheel repair -w {dest_dir} {wheel}"
