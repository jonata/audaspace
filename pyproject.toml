[build-system]
requires = ["scikit-build-core", "pybind11", "numpy", "setuptools", "build", "pybind11"]
build-backend = "scikit_build_core.build"

[project]
name = "audaspace"
version = "1.8.0"
description = "Audaspace is a high level audio library written in C++ with Python bindings"
readme = "README.md"
requires-python = ">=3.8"
license = "Apache-2.0"
authors = [
    {name = "Jörg Müller", email = "nexyon@gmail.com"}
]
keywords = ["audio", "sound", "3d-audio", "signal-processing"]
classifiers = [
    "Development Status :: 5 - Production/Stable",
    "Intended Audience :: Developers",
    "Operating System :: OS Independent",
    "Programming Language :: C++",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Topic :: Multimedia :: Sound/Audio",
]
dependencies = ["numpy"]

[project.urls]
Homepage = "https://github.com/audaspace/audaspace"
Documentation = "https://audaspace.github.io"
Repository = "https://github.com/audaspace/audaspace"
Issues = "https://github.com/audaspace/audaspace/issues"

[tool.scikit-build]
minimum-version = "0.8"
build-dir = "build/{wheel_tag}"
cmake.build-type = "Release"
wheel.exclude = ["include/", "lib/pkgconfig/"]
install.strip = false
wheel.py-api = "py3"
wheel.expand-macos-universal-tags = true


[tool.scikit-build.cmake.define]
BUILD_DEMOS = "OFF"
SHARED_LIBRARY = "ON"
WITH_C = "ON"
WITH_DOCS = "OFF"
WITH_BINDING_DOCS = "OFF"
WITH_PYTHON = "ON"
WITH_PYTHON_MODULE = "ON"
SEPARATE_C = "OFF"
CMAKE_MESSAGE_LOG_LEVEL = "VERBOSE"
CMAKE_BUILD_TYPE = "Release"

# Bundle all static dependencies
WITH_FFMPEG = "ON"
WITH_LIBSNDFILE = "ON"
WITH_OPENAL = "ON"
WITH_SDL = "ON"
USE_SDL2 = "ON"

# Use plugins as static libraries (bundled)
PLUGIN_FFMPEG = "OFF"
PLUGIN_LIBSNDFILE = "OFF"
PLUGIN_OPENAL = "OFF"
PLUGIN_SDL = "OFF"

# Platform-specific audio backends
WITH_PULSEAUDIO = {env = "WITH_PULSEAUDIO", default = "OFF"}
WITH_PIPEWIRE = {env = "WITH_PIPEWIRE", default = "OFF"}
WITH_JACK = {env = "WITH_JACK", default = "OFF"}
WITH_WASAPI = {env = "WITH_WASAPI", default = "OFF"}
WITH_COREAUDIO = {env = "WITH_COREAUDIO", default = "OFF"}

PLUGIN_PULSEAUDIO = "OFF"
PLUGIN_PIPEWIRE = "OFF"
PLUGIN_JACK = "OFF"
PLUGIN_WASAPI = "OFF"
PLUGIN_COREAUDIO = "OFF"

# Dynload for platform libraries
DYNLOAD_JACK = "ON"
DYNLOAD_PULSEAUDIO = "ON"
DYNLOAD_PIPEWIRE = "ON"

# Optional features
WITH_FFTW = "ON"
WITH_RUBBERBAND = "ON"

[tool.cibuildwheel]
build = "cp38-* cp39-* cp310-* cp311-* cp312-*"
skip = "*-musllinux_*"

[tool.cibuildwheel.linux]
before-all = [
    "yum install -y https://download1.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm || true",
    "yum install -y cmake ffmpeg-devel libsndfile-devel openal-soft-devel SDL2-devel fftw-devel pulseaudio-libs-devel jack-audio-connection-kit-devel patchelf || true",
    "dnf install -y ninja-build",
    "apt-get update || true",
    "apt-get install -y build-essential cmake pkg-config nasm yasm libavcodec-dev libavformat-dev libavutil-dev libswresample-dev libsndfile1-dev libopenal-dev libsdl2-dev libfftw3-dev libjack-jackd2-dev libpulse-dev libx11-dev libxext-dev libxfixes-dev libxrandr-dev libxcursor-dev libxinerama-dev libegl1-mesa-dev libgl1-mesa-dev libsamplerate0-dev libpipewire-0.3-dev || true",
]
environment = { WITH_PULSEAUDIO = "ON", WITH_JACK = "ON" }
repair-wheel-command = "auditwheel repair -w {dest_dir} {wheel} --lib-sdir . || cp {wheel} {dest_dir}/"

[tool.cibuildwheel.macos]
before-all = [
    "brew install ffmpeg libsndfile sdl2 fftw || true",
]
repair-wheel-command = "delocate-wheel --require-archs {delocate_archs} -w {dest_dir} -v {wheel}"
environment = { WITH_COREAUDIO = "ON", MACOSX_DEPLOYMENT_TARGET = "10.15" }

[tool.cibuildwheel.windows]
before-all = [
    "choco install -y --no-progress cmake ninja pkgconfiglite",
]
before-build = [
    "pip install delvewheel",
    "vcpkg install --triplet=x64-windows ffmpeg[avcodec,avformat,avutil,swresample]:x64-windows libsndfile:x64-windows openal-soft:x64-windows sdl2:x64-windows fftw3:x64-windows || echo 'vcpkg install failed, continuing'",
]
repair-wheel-command = "delvewheel repair -w {dest_dir} {wheel} --add-path C:/vcpkg/installed/x64-windows/bin || cp {wheel} {dest_dir}/"
environment = { WITH_WASAPI = "ON", CMAKE_TOOLCHAIN_FILE = "C:/vcpkg/scripts/buildsystems/vcpkg.cmake", VCPKG_TARGET_TRIPLET = "x64-windows" }
