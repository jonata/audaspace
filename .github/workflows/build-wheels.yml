name: Build Python Wheels

on:
  push:
    branches: [ main, master, github-actions-tests ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build_wheels:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            cibw_archs: "x86_64"
          - os: macos-13  # Intel
            cibw_archs: "x86_64"
          - os: macos-14  # Apple Silicon  
            cibw_archs: "arm64"
          - os: windows-latest
            cibw_archs: "AMD64"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install cibuildwheel
        run: python -m pip install --upgrade pip cibuildwheel==2.16.5

      # ===== Linux Setup =====
      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config
          sudo apt-get install -y libavcodec-dev libavformat-dev libavutil-dev libswresample-dev
          sudo apt-get install -y libsndfile1-dev libopenal-dev libsdl2-dev libfftw3-dev
          sudo apt-get install -y libjack-dev libpulse-dev

      # ===== macOS Setup =====
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja pkg-config
          brew install ffmpeg libsndfile openal-soft sdl2 fftw

      # ===== Windows Setup =====
      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          git clone --depth 1 https://github.com/Microsoft/vcpkg.git C:/vcpkg-ci
          C:/vcpkg-ci/bootstrap-vcpkg.bat

      - name: Install Windows dependencies via vcpkg
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          C:\vcpkg-ci\vcpkg.exe install ffmpeg[core,avcodec,avformat,avutil,swresample]:x64-windows libsndfile:x64-windows openal-soft:x64-windows sdl2:x64-windows fftw3:x64-windows

      # ===== Build Wheels =====
      - name: Build wheels
        env:
          CIBW_BUILD: cp38-* cp39-* cp310-* cp311-* cp312-* cp313-*
          CIBW_SKIP: pp* *-musllinux*
          CIBW_ARCHS: ${{ matrix.cibw_archs }}
          CIBW_BUILD_VERBOSITY: 1
          CIBW_ENVIRONMENT_LINUX: >
            CMAKE_PREFIX_PATH=/usr
            PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig
          CIBW_ENVIRONMENT_MACOS: >
            CMAKE_PREFIX_PATH=/opt/homebrew:/usr/local
            PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig:/usr/local/lib/pkgconfig
            MACOSX_DEPLOYMENT_TARGET=11.0
          CIBW_ENVIRONMENT_WINDOWS: >
            CMAKE_PREFIX_PATH=C:/vcpkg-ci/installed/x64-windows
            CMAKE_TOOLCHAIN_FILE=C:/vcpkg-ci/scripts/buildsystems/vcpkg.cmake
          CIBW_BEFORE_BUILD_LINUX: |
            yum install -y cmake3 || apt-get install -y cmake
          CIBW_BEFORE_BUILD_MACOS: |
            brew list cmake || brew install cmake
          CIBW_TEST_REQUIRES: numpy
          CIBW_TEST_COMMAND: python {project}/test_wheel.py
        run: python -m cibuildwheel --output-dir dist

      # ===== Verify =====
      - name: List built wheels
        shell: bash
        run: |
          ls -lh dist/
          echo ""
          echo "Built wheels:"
          python -c "from pathlib import Path; [print(f'  {w.name}') for w in sorted(Path('dist').glob('*.whl'))]"

      - name: Inspect wheel contents
        shell: bash  
        run: |
          python -c "
          import zipfile
          from pathlib import Path
          for wheel in sorted(Path('dist').glob('*.whl'))[:2]:  # Check first 2
              print(f'\n=== {wheel.name} ===')
              with zipfile.ZipFile(wheel) as z:
                  files = z.namelist()
                  exts = ['.so', '.pyd', '.dylib', '.dll']
                  binaries = [f for f in files if any(f.endswith(ext) or ext in f for ext in exts)]
                  if binaries:
                      print(f'Found {len(binaries)} binary files:')
                      for f in sorted(binaries)[:5]:
                          print(f'  {f}')
                  else:
                      print('  WARNING: No binary files found!')
          "

      # ===== Upload Artifacts =====
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.cibw_archs }}
          path: dist/*.whl
          retention-days: 7

  # ===== Publish to PyPI =====
  publish_pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build_wheels
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist/
          merge-multiple: true

      - name: List wheels
        run: |
          ls -lh dist/
          echo "Total wheels: $(ls -1 dist/*.whl | wc -l)"

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true
          verbose: true
