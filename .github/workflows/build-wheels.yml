name: Build and Publish Wheels

on:
  push:
    branches: [ main, master, github-actions-tests ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: 
          - ubuntu-24.04
          - macos-13  # Intel
          - macos-14  # Apple Silicon
          - windows-2022

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install cibuildwheel and dependencies
        run: python -m pip install cibuildwheel==2.16.5 build twine

      # Linux: Install system dependencies
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config
          sudo apt-get install -y libavcodec-dev libavformat-dev libavutil-dev libswresample-dev
          sudo apt-get install -y libsndfile1-dev libopenal-dev libsdl2-dev libfftw3-dev
          sudo apt-get install -y libjack-dev libpulse-dev libpipewire-0.3-dev

      # macOS: Install dependencies via Homebrew
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja pkg-config
          brew install ffmpeg libsndfile openal-soft sdl2 fftw

      # Windows: Set up vcpkg and install dependencies
      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg-ci
          C:\vcpkg-ci\bootstrap-vcpkg.bat
          echo "VCPKG_ROOT=C:\vcpkg-ci" >> $GITHUB_ENV
        shell: bash

      - name: Install Windows dependencies via vcpkg
        if: runner.os == 'Windows'
        run: |
          C:\vcpkg-ci\vcpkg.exe install ffmpeg[core,avcodec,avformat,avutil,swresample]:x64-windows libsndfile:x64-windows openal-soft:x64-windows sdl2:x64-windows fftw3:x64-windows
        shell: cmd

      - name: Build wheels
        run: python -m cibuildwheel --output-dir dist
        env:
          CIBW_BUILD: cp38-* cp39-* cp310-* cp311-* cp312-* cp313-*
          CIBW_SKIP: "*-musllinux* pp*"
          CIBW_ARCHS_MACOS: "x86_64 arm64"
          CIBW_ARCHS_LINUX: "x86_64"
          CIBW_ARCHS_WINDOWS: "AMD64"
          # Build settings
          CIBW_BUILD_VERBOSITY: 1
          # Test settings
          CIBW_TEST_REQUIRES: numpy
          CIBW_TEST_COMMAND: "python {project}/test_wheel.py"

      - name: List built wheels
        run: |
          python -c "
          import os
          from pathlib import Path
          print('\n=== Built Wheels ===')
          for wheel in sorted(Path('dist').glob('*.whl')):
              size = wheel.stat().st_size / (1024*1024)
              print(f'{wheel.name:60s} {size:6.2f} MB')
          "

      - name: Inspect wheel contents
        run: |
          python -c "
          import zipfile
          from pathlib import Path
          
          for wheel in sorted(Path('dist').glob('*.whl')):
              print(f'\n=== {wheel.name} ===')
              with zipfile.ZipFile(wheel) as z:
                  files = [f.filename for f in z.filelist]
                  # Find binary files
                  binaries = [f for f in files if any(ext in f for ext in ['.so', '.pyd', '.dylib', '.dll'])]
                  if binaries:
                      print('Binary files:')
                      for f in sorted(binaries):
                          info = z.getinfo(f)
                          print(f'  {f} ({info.file_size / 1024:.1f} KB)')
                  else:
                      print('  No binary files found!')
          "

      - name: Test wheel in clean environment
        run: |
          python -m venv test_venv
          
          if [ "$RUNNER_OS" == "Windows" ]; then
            source test_venv/Scripts/activate
          else
            source test_venv/bin/activate
          fi
          
          pip install numpy
          pip install dist/audaspace-*-cp312-*.whl
          
          python test_wheel.py
        shell: bash

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: dist/*.whl
          retention-days: 7

  publish_pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build_wheels
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist/
          merge-multiple: true

      - name: List all wheels
        run: |
          ls -lh dist/
          echo "Total wheels:"
          ls -1 dist/*.whl | wc -l

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true
          verbose: true



# choco install -y cmake ninja pkgconfiglite ffmpeg
# vcpkg install libsndfile openal-soft sdl2 fftw3