name: Build Python Wheels

on:
  push:
    branches: [ main, master, github-actions-tests ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build_wheels:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            name: Linux
          - os: macos-13
            name: macOS Intel
          - os: macos-14
            name: macOS ARM
          - os: windows-2022
            name: Windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: python -m pip install --upgrade pip cibuildwheel==2.16.5

      # ===== Linux Setup =====
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config
          sudo apt-get install -y libavcodec-dev libavformat-dev libavutil-dev libswresample-dev
          sudo apt-get install -y libsndfile1-dev libopenal-dev libsdl2-dev libfftw3-dev
          sudo apt-get install -y libjack-dev libpulse-dev libpipewire-0.3-dev

      # ===== macOS Setup =====
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja pkg-config
          brew install ffmpeg libsndfile openal-soft sdl2 fftw

      # ===== Windows Setup =====
      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:/vcpkg-ci
          C:/vcpkg-ci/bootstrap-vcpkg.bat
          echo "VCPKG_ROOT=C:/vcpkg-ci" >> $GITHUB_ENV

      - name: Install Windows dependencies
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          C:\vcpkg-ci\vcpkg.exe install ffmpeg[core,avcodec,avformat,avutil,swresample]:x64-windows libsndfile:x64-windows openal-soft:x64-windows sdl2:x64-windows fftw3:x64-windows

      - name: Set Windows environment
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "CMAKE_PREFIX_PATH=C:/vcpkg-ci/installed/x64-windows" >> $GITHUB_ENV
          echo "CMAKE_TOOLCHAIN_FILE=C:/vcpkg-ci/scripts/buildsystems/vcpkg.cmake" >> $GITHUB_ENV

      # ===== Build Wheels =====
      - name: Build wheels
        run: python -m cibuildwheel --output-dir dist
        env:
          CIBW_BUILD_VERBOSITY: 1

      # ===== Verify and Test =====
      - name: List wheels
        shell: bash
        run: |
          ls -lh dist/
          python -c "from pathlib import Path; wheels = list(Path('dist').glob('*.whl')); print(f'\nBuilt {len(wheels)} wheel(s)'); [print(f'  {w.name} ({w.stat().st_size / 1024 / 1024:.1f} MB)') for w in wheels]"

      - name: Inspect wheel contents
        shell: bash
        run: |
          python -c "
          import zipfile
          from pathlib import Path
          for wheel in Path('dist').glob('*.whl'):
              print(f'\n=== {wheel.name} ===')
              with zipfile.ZipFile(wheel) as z:
                  binaries = [f for f in z.namelist() if any(ext in f for ext in ['.so', '.pyd', '.dylib', '.dll'])]
                  if binaries:
                      print('Binary files:')
                      for f in sorted(binaries)[:10]:
                          info = z.getinfo(f)
                          print(f'  {f} ({info.file_size/1024:.1f} KB)')
                  else:
                      print('  WARNING: No binary files found!')
          "

      - name: Test wheel installation
        shell: bash
        run: |
          python -m venv test_env
          
          if [ "$RUNNER_OS" == "Windows" ]; then
            source test_env/Scripts/activate
          else
            source test_env/bin/activate
          fi
          
          pip install numpy
          pip install dist/audaspace-*-cp312-*.whl
          
          python -c "import aud; print(f'audaspace imported from: {aud.__file__}')"
          python test_wheel.py

      # ===== Upload Artifacts =====
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: dist/*.whl
          retention-days: 7

  # ===== Publish to PyPI =====
  publish_pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build_wheels
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist/
          merge-multiple: true

      - name: List wheels
        run: |
          ls -lh dist/
          echo "Total wheels: $(ls -1 dist/*.whl | wc -l)"

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true
          verbose: true
