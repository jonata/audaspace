name: Build Python Wheels

on:
  workflow_dispatch:
  push:
    branches:
      - github-actions-tests
  pull_request:

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-2022, macos-13, macos-14]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up QEMU for cross-architecture builds on Linux
        if: runner.os == 'Linux'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.17.0
        env:
          # Install dependencies on Linux
          CIBW_BEFORE_BUILD_LINUX: >
            apt-get update &&
            apt-get install -y --no-install-recommends
            build-essential
            cmake
            libjack-dev
            libpulse-dev
            libsndfile-dev
            libfftw3-dev
            libavcodec-dev
            libavformat-dev
            libswresample-dev
            libswscale-dev
            libsdl2-dev
            librubberband-dev

          # Install dependencies on macOS
          CIBW_BEFORE_BUILD_MACOS: >
            brew install
            cmake
            ffmpeg
            fftw
            jack
            libsndfile
            rubberband
            sdl2

          # Install dependencies on Windows using vcpkg
          CIBW_BEFORE_BUILD_WINDOWS: |
            git clone --depth=1 https://github.com/microsoft/vcpkg.git
            ./vcpkg/bootstrap-vcpkg.bat -disableMetrics
            ./vcpkg/vcpkg.exe install fftw3:x64-windows-static libsndfile:x64-windows-static sdl2:x64-windows-static ffmpeg[core,swresample,swscale,avcodec,avformat]:x64-windows-static rubberband:x64-windows-static --triplet x64-windows-static --x-buildtrees-root D:\b

          # Configure CMake for vcpkg on Windows
          CIBW_CMAKE_OPTIONS_WINDOWS: -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-static

          # Skip PyPy builds as they often have compatibility issues with C extensions
          CIBW_SKIP: "pp*"
          
          # Tell cibuildwheel where the python sources are
          CIBW_PROJECT_REQUIRES_PYTHON: ">=3.8"

          # Provide a command to test the installed wheel
          CIBW_TEST_COMMAND: "python {project}/tests/simple_test.py"
          
          # No extra dependencies needed for testing
          CIBW_TEST_REQUIRES: ""

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl
